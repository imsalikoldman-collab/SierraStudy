# Спецификация отображения графических элементов после парсинга YAML
*Версия:* 1.0 • *Дата формирования файла:* 2025-10-29 (Europe/Berlin)  
*Основание:* YML v1.5-min-obj, текстовые требования к отображению

---

## 0) Назначение и охват
Цель: однозначно преобразовать разобранный YAML (**YML v1.5-min-obj**) в набор графических объектов Sierra Chart (ACSIL) и поддерживать их актуальность при обновлении данных/прокрутке графика.  
Вход — корректный YAML v1.5; выход — отрисованные зоны/уровни/метки на соответствующих чартах. Основные сущности: `generated_at`, пары `zone_long` / `zone_short` (каждая не чаще одного раза на тикер), необязательный `flip`.

---

## 1) Сопоставление сущностей YAML → графические объекты

### 1.1 Общие правила координат
- Время начала для **всех** объектов — `generated_at`. На этом времени ставится вертикальный маркер «Plan generated …».
- Все прямоугольники (диапазоны) и лучи уровней «тянутся вправо» от `generated_at` до правой границы графика (обновляются по мере сдвига графика).
- Ценовые значения приводятся к `TickSize` инструмента. Привязка по инструментам выполняется по корню тикера (например, NQ ↔ NQ/MNQ; ES ↔ ES/MES).

### 1.2 Зоны (`zone_long`, `zone_short`)
Для каждой из двух возможных зон:
- Поле `range: [low, high]` → прямоугольник (полупрозрачный) от времени `generated_at` до правой границы окна, по ценам `low..high`.
  - Цвет: `zone_long` — зелёный; `zone_short` — красный.
  - В центре прямоугольника используется текст из обязательного поля `label`.
- Поле `invalidation: [low, high]` (если есть) → дополнительный прямоугольник с пониженной непрозрачностью над основной зоной (приглушённый серый).
- Обязательные поля зоны: `label`, `range`, `sl`, `tp1`, `tp2`. Диапазоны должны удовлетворять `low < high`; при нарушении зона пропускается.

### 1.3 Уровни (`sl`, `tp1`, `tp2`)
- Отображение уровня — **горизонтальный луч вправо** (`DRAWING_HORIZONTAL_RAY`) на цене уровня: `BeginDateTime = generated_at`, `ExtendRight = 1`, минимальный `EndDateTime` используется только для фиксации начальной точки.
- Стиль линий и толщина задаются общим значением (см. §3.1) и применяются ко всем уровням; цвет различается по типу уровня. Подпись формата «Имя + значение» выводится над линией.

### 1.4 Flip‑зона (`flip`)
- Необязательная и единственная. Рисуется как **нейтральный прямоугольник** (например, жёлтый/фиолетовый в рамках темы), тянется вправо; текст `label` — справа по центру диапазона.

### 1.5 Маркер времени генерации (`generated_at`)
- Вертикальная линия на `generated_at` с подписью «Plan generated YYYY‑MM‑DD HH:MM TZ». Обновляется/удерживается через `UseTool` с сохранением `LineNumber` (см. §4).

---

## 2) Слои и порядок отрисовки (z‑order)
Снизу вверх: `invalidation` → `zone` → `flip` → `lines (sl/tp)` → `labels` → `generated_at`.  
Стек фиксированный для читаемости и предсказуемости перекрытий.

---

## 3) Стиль/оформление по умолчанию (может быть вынесено в тему)
- **Levels Settings:** единые параметры для линий уровней (`sl/tp1/tp2`):
  - `LineStyle` — стиль линии (по умолчанию `LINESTYLE_DASH`).
  - `LineWidth` — толщина линии (по умолчанию `1`).
  - `FontFace` — шрифт подписи уровней (по умолчанию `Consolas`).
  - `FontSize` — размер шрифта (по умолчанию `8`).
  - `FontBold` — использование жирного начертания (по умолчанию `false`).
  - `TextAlignment` — расположение текста относительно линии (по умолчанию `DT_CENTER|DT_BOTTOM`, текст над линией).
- **Zones (buy/sell):** заливка 25–35%, контур 1–2 px; buy — зелёный, sell — красный.
- **Invalid:** заливка 15–20%, контур ненавязчивый (серый/приглушённый).
- **Flip:** нейтральный акцент + центрированная подпись `label`.
- **SL/TP:** тонкие пунктирные; SL — красный, TP — зелёный; у правой границы — «SL/TPn: price».
- **Generated marker:** линия 2 px, контрастный цвет, подпись «Plan generated …».

---

## 4) Идентификация и идемпотентные обновления
- **Identity зоны (при отсутствии явного ID):** пара `(direction, range.low, range.high)`.
  - Изменился `range` → старая зона удаляется, создаётся новая;
  - `range` прежний, меняются `sl|tp|invalid|notes` → зона обновляется на месте.
- Для каждого нарисованного объекта сохраняем его `LineNumber` в постоянном хранилище study и при последующих проходах используем `UTAM_ADD_OR_ADJUST` с этим `LineNumber`, исключая дубли.
- Для единичных отметок при первичном создании допустим `UTAM_ADD_ONLY_IF_NEW`.

---

## 5) Поведение расчёта/перерисовки
- **Автообновление вправо:** при изменении правой границы видимой области прямоугольники/лучи корректируют конечную координату (повторный `UseTool` с тем же `LineNumber`).  
- **Полный пересчёт/удаление:** при смене YAML (новый `generated_at` или состав зон) удаляем устаревшие объекты (для которых не нашлась identity/`LineNumber`).  
- **Удаление study:** программные рисунки удаляет Sierra автоматически; если используются пользовательские (`AddAsUserDrawnDrawing=1`), их требуется удалить вручную в коде при снятии study.

---

## 6) Размещение по чартах (routing)
- Секция `NQ` рендерится на чартах инструментов NQ/MNQ; секция `ES` — на ES/MES.  
- Если подходящего открытого чарта нет — фиксируем событие в лог и пропускаем рендер для этой секции.

---

## 7) Валидация входа (до рендера)
- `v == "1.5-min-obj"`, обязательны: `generated_at` (ISO‑8601 с TZ), `zone_long` / `zone_short` (каждая 0 или 1 объект), `flip` ≤ 1.
- Для зон: наличие `label`, `range.low < range.high`, присутствуют `sl`, `tp1`, `tp2`; `invalidation` опционален. Неизвестные поля игнорируются; элементы с нарушениями — пропускаются.

---

## 8) Детали реализации в ACSIL (рекомендуемая техника)
- Все объекты создаются через `sc.UseTool(s_UseTool)`, перед заполнением — `Tool.Clear()`.
- Вертикальный маркер: `DRAWING_VERTICALLINE`, `AddMethod=UTAM_ADD_OR_ADJUST`, `BeginDateTime=generated_at`, сохранение/повторное использование `LineNumber`.
- Линии уровней — горизонтальные лучи (right‑ray), прямоугольники зон — соответствующие `DrawingType` и пары координат (время/цена).
- Во избежание дубликатов/«мерцания» — «один раз на бар», проверка индекса последнего закрытого бара; AutoLoop при необходимости.

---

## 9) Нормализация текстовых требований (кратко)
- Прямоугольники для всех структур с `range`, старт от `generated_at`, тянуть вправо.
- `zone_long` — зелёный, `zone_short` — красный; `invalidation` — серый; `flip` — фиолетовый/жёлтый (тема).
- У прямоугольников — центрированная подпись; уровни — горизонтальные лучи от `generated_at` вправо (SL — красный, TP — зелёные) со строкой «имя + значение».

---

## 10) Карта соответствий (термины)
| YAML                        | Визуальный элемент         | Стиль по умолчанию                   |
|----------------------------|----------------------------|--------------------------------------|
| `zone_long`                | Прямоугольник              | Зелёный, 25–35%                      |
| `zone_short`               | Прямоугольник              | Красный, 25–35%                      |
| `zone_*.invalidation`      | Прямоугольник поверх зоны  | Серый, 15–20%                        |
| `sl`                       | Горизонтальный луч         | Красный, тонкий, пунктир             |
| `tp1`, `tp2`               | Горизонтальный луч         | Зелёный, тонкий, пунктир             |
| `flip`                     | Прямоугольник + `label`    | Нейтральный акцент                   |
| `generated_at`             | Вертикальный маркер        | Контрастная линия 2 px + подпись     |

---

## 11) Тест‑кейсы приёмки (smoke/acceptance)
1. YAML без `flip`, с 2 зонами (buy/sell) → 2 прямоугольника, 0–2 `invalid`, по 3 луча (`sl`,`tp1`,`tp2`) на зону, вертикальный маркер `generated_at`.
2. Изменить `tp2` при неизменном `range` → корректируется только линия `tp2` (идентичность зоны сохраняется).
3. Изменить `range` → старая зона удаляется, появляется новая с новым `LineNumber`.
4. Удалить зону из YAML → соответствующие объекты исчезают после пересчёта (нет сопоставления по identity).
5. Смещение правой границы видимой области → все «тянущиеся» элементы обновляют конечную координату (повторный `UseTool` с тем же `LineNumber`).

---

## 12) Приложения
**A. Источники**  
- Формальная спецификация: *YML v1.5-min-obj* (локальный файл).
- Текстовые требования к отображению (локальный файл).

**B. Мини‑чеклист для QA**  
- [ ] Вертикальный маркер на `generated_at` присутствует и подписан.  
- [ ] Зоны рендерятся с корректным цветом по `direction`.  
- [ ] Диапазон `invalidation` отображается поверх и не перекрывает подписи зон.  
- [ ] SL/TP — пунктирные, цвета корректные, подписи справа с ценой.  
- [ ] Flip (если задан) — один, нейтральный, с `label`.  
- [ ] При изменении YAML не создаются дубликаты (переиспользуются `LineNumber`).  
- [ ] Объекты тянутся вправо до правой границы видимой области.  
- [ ] Размещение по чартах соответствует инструментам (NQ/MNQ, ES/MES).
